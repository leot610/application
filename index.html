<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <title>Chat</title>
        <link rel="stylesheet" type="text/css" href="css/style.css" media="all" />
        <script type="text/javascript" src="js/jquery-1.10.2.js"></script>   
    </head>
    <body>
        <form>
                <input type="message" id="message" name="message">
                <input type="submit" value="" class="button">
                    <img src="img/refresh.png" id="refresh"></img>
        </form>
        <div id="chat"></div>
        <script>
            chat();
            window.setInterval(function(){
                var current_count = $("#counter").text();
                $.getJSON( "http://www.codeigniter.in/projects/chat/response.php?format=json&num=10000000", function( json ) {
                    if(json.posts.length > current_count)
                    {
                        chat();
                    }
                });         
            }, 500);
            $('#refresh').click(function(){
                chat();
            });
            $('form').submit(function(){
                var landmarkID = $(this).parent().attr('data-landmark-id');
                var postData = $(this).serialize();
                $.ajax({
                        type: 'POST',
                        data: postData+'&amp;lid='+landmarkID,
                        url: 'http://www.codeigniter.in/projects/chat/save.php',
                        success: function(data){
                                console.log(data);
                                //alert('Your comment was successfully added');
                                $("#message").val('');
                                chat();
                        },
                        error: function(){
                                console.log(data);
                                alert('There was an error adding your comment');
                        }
                });
                return false;
            });
            function chat()
            {
                $( "#chat" ).empty();
                $.getJSON( "http://www.codeigniter.in/projects/chat/response.php?format=json&num=10", function( json ) {
                                        for (var i = 0; i < json.posts.length; i++) 
                                        { 
                                            $('#chat').append('<p> User: ' + json.posts[i].post.message + '</p>');
                                        }
                                        $('#chat').append('<p id="counter" style="display:none;">' + json.posts.length + '</p>');
                });     
                
            }

</script>
    </body>

</html>